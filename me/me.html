<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Gallery 📸</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='me/gallery.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="gallery-container">
    <div class="gallery-header">
      <h1>Our Beautiful Memories 💙</h1>
      <p>Click on any album to view our precious moments together</p>
    </div>

    <div class="albums-grid">
      <div class="album-card" onclick="openAlbum('firstdate')">
        <div class="album-cover">
          <img src="/me/images/g1.jfif" alt="First Date" class="cover-image" />
          <div class="album-overlay">
            <div class="album-icon">💕</div>
            <h3>First Date</h3>
            <p>February 14</p>
            <span class="photo-count" id="firstdate-count">Loading...</span>
          </div>
        </div>
      </div>

      <div class="album-card" onclick="openAlbum('walter')">
        <div class="album-cover">
          <img src="/me/images/f1.jfif" alt="Walter Date" class="cover-image" />
          <div class="album-overlay">
            <div class="album-icon">🌟</div>
            <h3>Walter Date</h3>
            <p>Special moments</p>
            <span class="photo-count" id="walter-count">Loading...</span>
          </div>
        </div>
      </div>

      <div class="album-card" onclick="openAlbum('tricia')">
        <div class="album-cover">
          <img src="/me/images/h1.jfif" alt="Tricia's Debut" class="cover-image" />
          <div class="album-overlay">
            <div class="album-icon">✨</div>
            <h3>Tricia's Debut</h3>
            <p>Celebration night</p>
            <span class="photo-count" id="tricia-count">Loading...</span>
          </div>
        </div>
      </div>

      <div class="album-card" onclick="openAlbum('lastpicture')">
        <div class="album-cover">
          <img src="/me/images/l1.jfif" alt="Last Picture" class="cover-image" />
          <div class="album-overlay">
            <div class="album-icon">💫</div>
            <h3>Last Picture</h3>
            <p>Recent memories</p>
            <span class="photo-count" id="lastpicture-count">Loading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Viewer Modal -->
    <div class="photo-modal" id="photoModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="albumTitle">Album Name</h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="photo-grid" id="photoGrid"></div>
        <div class="modal-navigation">
          <button class="nav-btn" onclick="closeModal()">Close Gallery</button>
        </div>
      </div>
    </div>

    <!-- Full Image Viewer -->
    <div class="image-viewer" id="imageViewer" style="display: none;">
      <div class="viewer-content">
        <button class="close-viewer" onclick="closeImageViewer()">&times;</button>
        <button class="nav-arrow prev-arrow" onclick="previousImage()">‹</button>
        <img id="fullImage" src="" alt="Full size image" />
        <button class="nav-arrow next-arrow" onclick="nextImage()">›</button>
        <div class="image-info">
          <span id="imageCounter">1 / 1</span>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation">
      <button class="nav-button back-btn" onclick="goBack()">← Back to Chat</button>
      <button class="nav-button visit-btn" onclick="window.location.href='/visit'">Visit Room 💙</button>

    </div>

    <!-- Floating Hearts -->
    <div class="floating-hearts">
      <div class="heart">💙</div>
      <div class="heart">💕</div>
      <div class="heart">💖</div>
      <div class="heart">💙</div>
      <div class="heart">💕</div>
    </div>
  </div>

  <script>
    const IN_SHELL = (()=>{ try { return window.parent && window.parent !== window; } catch(e){ return false; } })();
    const albums = {
      firstdate: { name: "First Date - February 14", prefix: "g", icon: "💕" },
      walter: { name: "Walter Date", prefix: "f", icon: "🌟" },
      tricia: { name: "Tricia's Debut", prefix: "h", icon: "✨" },
      lastpicture: { name: "Last Picture", prefix: "l", icon: "💫" }
    };

    let currentAlbum = '';
    let currentImages = [];
    let currentImageIndex = 0;

    function loadPhotoCounts() {
      Object.keys(albums).forEach(albumKey => {
        const album = albums[albumKey];
        let count = 0;
        for (let i = 1; i <= 20; i++) {
          const img = new Image();
          img.onload = () => {
            count++;
            document.getElementById(`${albumKey}-count`).textContent = `${count} photos`;
          };
          img.onerror = () => {
            if (count === 0 && i === 1) {
              document.getElementById(`${albumKey}-count`).textContent = 'No photos';
            }
          };
          img.src = `/me/images/${album.prefix}${i}.jfif`;
        }
      });
    }

    function openAlbum(albumKey) {
      currentAlbum = albumKey;
      const album = albums[albumKey];
      currentImages = [];

      document.getElementById('albumTitle').textContent = album.name;
      document.getElementById('photoModal').style.display = 'flex';

      const photoGrid = document.getElementById('photoGrid');
      photoGrid.innerHTML = '<div class="loading">Loading photos...</div>';

      let loadedCount = 0;
      const maxImages = 20;

      for (let i = 1; i <= maxImages; i++) {
        const img = new Image();
        img.onload = () => {
          const imagePath = `/me/images/${album.prefix}${i}.jfif`;
          currentImages.push(imagePath);

          if (loadedCount === 0) photoGrid.innerHTML = '';

          const photoItem = document.createElement('div');
          photoItem.className = 'photo-item';
          photoItem.innerHTML = `
            <img src="${imagePath}" alt="${album.name} ${i}" onclick="openImageViewer(${currentImages.length - 1})" />
            <div class="photo-overlay"><span>${album.prefix}${i}</span></div>
          `;
          photoGrid.appendChild(photoItem);
          loadedCount++;
        };
        img.onerror = () => {
          if (loadedCount === 0 && i === maxImages) {
            photoGrid.innerHTML = '<div class="no-photos">No photos found in this album</div>';
          }
        };
        img.src = `/me/images/${album.prefix}${i}.jfif`;
      }
    }

    function closeModal() {
      document.getElementById('photoModal').style.display = 'none';
      currentAlbum = '';
      currentImages = [];
    }

    function openImageViewer(index) {
      currentImageIndex = index;
      document.getElementById('imageViewer').style.display = 'flex';
      document.getElementById('fullImage').src = currentImages[index];
      updateImageCounter();
    }

    function closeImageViewer() {
      document.getElementById('imageViewer').style.display = 'none';
    }

    function previousImage() {
      if (currentImageIndex > 0) {
        currentImageIndex--;
        document.getElementById('fullImage').src = currentImages[currentImageIndex];
        updateImageCounter();
      }
    }

    function nextImage() {
      if (currentImageIndex < currentImages.length - 1) {
        currentImageIndex++;
        document.getElementById('fullImage').src = currentImages[currentImageIndex];
        updateImageCounter();
      }
    }

    function updateImageCounter() {
      document.getElementById('imageCounter').textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
    }

    function goBack() {
      window.location.href = '/me';
    }

    window.addEventListener('load', () => loadPhotoCounts());

    document.addEventListener('keydown', (e) => {
      if (document.getElementById('imageViewer').style.display === 'flex') {
        if (e.key === 'ArrowLeft') previousImage();
        if (e.key === 'ArrowRight') nextImage();
        if (e.key === 'Escape') closeImageViewer();
      }
      if (document.getElementById('photoModal').style.display === 'flex') {
        if (e.key === 'Escape') closeModal();
      }
    });
    // Auto-resume background music on this page (disabled when inside app shell to prevent overlap)
    (function(){
      function resume(){
        try{
          if (IN_SHELL) {
            if (window._bgm) { try{ window._bgm.pause(); }catch(e){}; window._bgm = null; }
            return; // Shell owns the music
          }
          const s = localStorage.getItem('bgm_song');
          const p = localStorage.getItem('bgm_playing') === 'true';
          const t = parseFloat(localStorage.getItem('bgm_time') || '0');
          if (s && p && !window._bgm) {
            const a = new Audio(`/me/music/${s}`);
            a.loop = true;
            a.addEventListener('loadedmetadata', ()=>{ if(!isNaN(t)){ try{ a.currentTime = t }catch(e){} } });
            a.play().then(()=>{
              window._bgm = a;
              a.ontimeupdate = ()=>{ try{ localStorage.setItem('bgm_time', String(a.currentTime||0)) }catch(e){} };
            }).catch(()=>{});
          }
        }catch(e){}
      }
      if (document.readyState === 'complete') resume(); else window.addEventListener('load', resume);
    })();
  </script>
</body>
</html>
