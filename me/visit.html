<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Visit EJ's Room üíô</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='me/visit.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
</head>
<body>
    <div class="room-container">
        <div class="room-background">
            <!-- Window -->
            <div class="window">
                <div class="window-frame">
                    <div class="window-pane"></div>
                    <div class="window-cross-h"></div>
                    <div class="window-cross-v"></div>
                </div>

        <!-- Mobile Toolbar -->
        <div class="mobile-toolbar" aria-label="Quick actions">
            <button class="toolbar-btn" onclick="openPopup('chat')" title="Chat">üí¨</button>
            <button class="toolbar-btn" onclick="openPopup('music')" title="Music">üéµ</button>
            <button class="toolbar-btn" onclick="openPopup('gallery')" title="Gallery">üì∏</button>
            <button class="toolbar-btn" onclick="openPopup('bed')" title="Bed">üõèÔ∏è</button>
            <button class="toolbar-btn" onclick="goBack()" title="Back">‚Ü©Ô∏è</button>
        </div>

        

                <div class="curtains">
                    <div class="curtain-left"></div>
                    <div class="curtain-right"></div>
                </div>
            </div>

            <!-- Bed -->
            <div class="bed">
                <div class="bed-frame"></div>
                <div class="blanket"></div>
                <div class="pillow"></div>
            </div>

            <!-- Desk with Laptop -->
            <div class="desk">
                <div class="desk-surface"></div>
                <div class="desk-legs"></div>
                <div class="laptop"></div>
                <div class="laptop-screen"></div>
            </div>

            <!-- Guitar Stand -->
            <div class="guitar-stand">
                <div class="guitar-acoustic">
                    <div class="guitar-body"></div>
                    <div class="guitar-neck"></div>
                    <div class="guitar-strings"></div>
                </div>
                <div class="guitar-electric">
                    <div class="guitar-body-electric"></div>
                    <div class="guitar-neck-electric"></div>
                </div>
            </div>

            <!-- Wardrobe -->
            <div class="wardrobe">
                <div class="wardrobe-body"></div>
                <div class="wardrobe-doors"></div>
                <div class="wardrobe-handles"></div>
                <div class="clothes-hanging">
                    <div class="shirt"></div>
                    <div class="jacket"></div>
                    <div class="pants"></div>
                </div>
            </div>

            <!-- Bookshelf -->
            <div class="bookshelf">
                <div class="shelf-frame"></div>
                <div class="books">
                    <div class="book book1"></div>
                    <div class="book book2"></div>
                    <div class="book book3"></div>
                    <div class="book book4"></div>
                </div>
            </div>

            <!-- Clickable Floor Lamp (acts as night switch) -->
            <div class="lamp on" id="floorLamp" onclick="toggleLamp()" aria-label="Lamp switch" role="button">
                <div class="shade"></div>
                <div class="stand"></div>
                <div class="base"></div>
            </div>

            <!-- Floor Items -->
            <div class="floor-items">
                <div class="shoes">
                    <div class="shoe-left"></div>
                    <div class="shoe-right"></div>
                </div>
                <div class="backpack"></div>
            </div>

            <!-- EJ in the room -->
            <div class="ej-character">
                <img src="{{ url_for('static', filename='images/me.jpg') }}" alt="EJ" class="ej-photo" />
                <div class="speech-bubble">
                    <p>Hey babe! Welcome to my room! üíô</p>
                    <div class="bubble-tail"></div>
                </div>
            </div>
        </div>

        <!-- Room Actions -->
        <div class="room-actions">
            <div class="action-card">
                <div class="action-icon">üõèÔ∏è</div>
                <h3>Sit on Bed</h3>
                <p>Relax and get comfy</p>
                <button class="action-btn" onclick="sitOnBed()">Sit</button>
            </div>

            <div class="action-card">
                <div class="action-icon">üí¨</div>
                <h3>Start Chat</h3>
                <p>Talk with EJ</p>
                <button class="action-btn" onclick="startChat()">Chat</button>
            </div>

            <div class="action-card">
                <div class="action-icon">üéµ</div>
                <h3>Play Music</h3>
                <p>Choose a song to play</p>
                <div class="music-options">
                    <button class="music-btn" onclick="playMusic('sofiathefirst.mp3.mp3')">Sofia the First</button>
                    <button class="music-btn" onclick="playMusic('purplebarbie.mp3.mp3')">Purple Barbie</button>
                    <button class="music-btn" onclick="playMusic('givemeyourforever.mp3.mp3')">Our Song üíô</button>
                </div>
                <button class="action-btn stop-music" onclick="stopMusic()" style="display: none;">Stop Music</button>
            </div>

            <div class="action-card">
                <div class="action-icon">üì∏</div>
                <h3>View Gallery</h3>
                <p>Our beautiful memories</p>
                <button class="action-btn" onclick="openGallery()">View Photos</button>
            </div>
        </div>

        <!-- Message Container -->
        <div class="message-container" id="messageContainer" style="display: none;">
            <div class="message-header">
                <h3>üíå Message from You</h3>
                <button class="close-message" onclick="closeMessage()">√ó</button>
            </div>
            <div class="message-content" id="messageContent">
                <!-- Messages will be displayed here -->
            </div>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button back-btn" onclick="goBack()">
                <span>‚Üê Back</span>
            </button>
        </div>

        <!-- Floating hearts -->
        <div class="floating-hearts">
            <div class="heart">üíô</div>
            <div class="heart">üíï</div>
            <div class="heart">üíñ</div>
            <div class="heart">üíô</div>
            <div class="heart">‚ú®</div>
        </div>

        
    </div>

    <!-- Subtle Night Overlay (darkens room when lamp is off) -->
    <div class="night-overlay" aria-hidden="true"></div>

    <!-- Centered Popup Overlay (outside room container to avoid stacking/perspective issues) -->
    <div id="popupOverlay" class="popup-overlay" aria-hidden="true" onclick="overlayClick(event)">
        <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
            <div class="popup-header">
                <h3 id="popupTitle">Actions</h3>
                <button class="popup-close" aria-label="Close" onclick="closePopup()">√ó</button>
            </div>
            <div id="popupContent" class="popup-content"></div>
        </div>
    </div>

    <script>
        

        // Lamp night mode switch
        function toggleLamp() {
            const body = document.body;
            const lamp = document.getElementById('floorLamp');
            const isNight = body.classList.toggle('night-on');
            if (isNight) {
                lamp.classList.remove('on');
                lamp.classList.add('off');
                localStorage.setItem('lamp_on', 'false');
            } else {
                lamp.classList.remove('off');
                lamp.classList.add('on');
                localStorage.setItem('lamp_on', 'true');
            }
        }

        // Restore lamp state on load
        (function restoreLamp() {
            const lampOn = localStorage.getItem('lamp_on');
            if (lampOn === 'false') {
                document.body.classList.add('night-on');
                const lamp = document.getElementById('floorLamp');
                if (lamp) { lamp.classList.remove('on'); lamp.classList.add('off'); }
            }
        })();

        // Popup helpers
        function openPopup(section) {
            const overlay = document.getElementById('popupOverlay');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');

            if (section === 'chat') {
                title.textContent = 'Start Chat';
                content.innerHTML = `
                    <p>Talk with EJ üí¨</p>
                    <button class="action-btn" onclick="startChat()">Go to Chat</button>
                `;
            } else if (section === 'music') {
                title.textContent = 'Play Music';
                content.innerHTML = `
                    <div class="music-options">
                        <button class="music-btn" onclick=\"playMusic('sofiathefirst.mp3.mp3')\">Sofia the First</button>
                        <button class="music-btn" onclick=\"playMusic('purplebarbie.mp3.mp3')\">Purple Barbie</button>
                        <button class="music-btn" onclick=\"playMusic('givemeyourforever.mp3.mp3')\">Our Song üíô</button>
                    </div>
                    <button class="action-btn stop-music" onclick="stopMusic()" style="display: none;">Stop Music</button>
                `;
            } else if (section === 'gallery') {
                title.textContent = 'View Gallery';
                content.innerHTML = `
                    <p>Our beautiful memories üì∏</p>
                    <button class="action-btn" onclick="openGallery()">View Photos</button>
                `;
            } else if (section === 'bed') {
                title.textContent = 'Sit on Bed';
                content.innerHTML = `
                    <p>Relax and get comfy üõèÔ∏è</p>
                    <button class="action-btn" onclick="sitOnBed()">Sit</button>
                `;
            }
        }

        function closePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');
        }

        function overlayClick(e) {
            if (e.target.id === 'popupOverlay') closePopup();
        }

        function sitOnBed() {
            showMessage("Come here, babe! Let's cuddle on the bed together üíô", "bed");
        }

        function startChat() {
            // Navigate to Messenger-like chat page
            window.location.href = '/chat';
        }

        let musicPlaying = false;
        let audio = null;
        let currentSong = '';
        const IN_SHELL = (function(){ try { return window.top !== window.self; } catch(e){ return true; } })();

        function playMusic(songFile) {
            // Stop current if playing
            if (musicPlaying) {
                stopMusic();
            }

            const title = getSongDisplayName(songFile);
            if (IN_SHELL && window.parent) {
                // Ask shell to take over background music
                window.parent.postMessage({ type: 'SET_BGM', action: 'play', song: songFile, title }, '*');
                musicPlaying = true;
                currentSong = songFile;
                // Update UI
                const p = document.querySelector('.action-card:nth-child(3) p');
                if (p) p.textContent = `Playing: ${title}`;
                const stopBtn = document.querySelector('.stop-music');
                if (stopBtn) stopBtn.style.display = 'block';
                const musicOptions = document.querySelector('.music-options');
                if (musicOptions) musicOptions.style.display = 'none';
                return;
            }

            // Fallback: local playback when not in app shell
            audio = new Audio(`/me/music/${songFile}`);
            audio.loop = true;
            audio.play()
                .then(() => {
                    musicPlaying = true;
                    currentSong = songFile;
                    const p = document.querySelector('.action-card:nth-child(3) p');
                    if (p) p.textContent = `Playing: ${title}`;
                    const stopBtn = document.querySelector('.stop-music');
                    if (stopBtn) stopBtn.style.display = 'block';
                    const musicOptions = document.querySelector('.music-options');
                    if (musicOptions) musicOptions.style.display = 'none';
                    saveMusicState();
                    if (audio) audio.ontimeupdate = () => saveMusicState();
                })
                .catch((error) => {
                    console.log('Could not play music:', error);
                    alert(`Music file not found: ${songFile}. Please check the me/music/ folder.`);
                });
        }

        function stopMusic() {
            if (IN_SHELL && window.parent) {
                window.parent.postMessage({ type: 'SET_BGM', action: 'stop' }, '*');
            }
            if (audio) { audio.pause(); audio = null; }
            musicPlaying = false;
            currentSong = '';
            const p = document.querySelector('.action-card:nth-child(3) p');
            if (p) p.textContent = 'Choose a song to play';
            const stopBtn = document.querySelector('.stop-music');
            if (stopBtn) stopBtn.style.display = 'none';
            const musicOptions = document.querySelector('.music-options');
            if (musicOptions) musicOptions.style.display = 'flex';
            localStorage.removeItem('bgm_song');
            localStorage.removeItem('bgm_time');
            localStorage.setItem('bgm_playing', 'false');
        }

        function getSongDisplayName(songFile) {
            const base = songFile.replace(/\.(mp3)(\.mp3)?$/i, '')
                                 .replace(/\/+/g, '/')
                                 .split('/')
                                 .pop();
            switch (base) {
                case 'sofiathefirst':
                    return 'Sofia the First';
                case 'purplebarbie':
                    return 'Purple Barbie';
                case 'givemeyourforever':
                    return 'Our Song üíô';
                default:
                    return base;
            }
        }

        function showMessage(message, type) {
            const bubble = document.querySelector('.speech-bubble p');
            const originalMessage = bubble.textContent;

            bubble.textContent = message;

            // Add special effects based on type
            if (type === 'bed') {
                document.querySelector('.bed').classList.add('highlight');
            } else if (type === 'music') {
                document.querySelector('.desk').classList.add('highlight');
            }

            setTimeout(() => {
                bubble.textContent = originalMessage;
                document.querySelectorAll('.highlight').forEach((el) => {
                    el.classList.remove('highlight');
                });
            }, 3000);
        }

        function goBack() {
            // Map previousPage values to Flask routes
            const routes = {
                sad: '/sadpage',
                happy: '/happypage',
                missing: '/missingpage',
                angry: '/angrypage',
                confused: '/confusedpage',
                hurt: '/hurtpage',
                fine: '/finepage',
                choices: '/choices'
            };

            const previousPage = localStorage.getItem('previousPage');
            if (previousPage && routes[previousPage]) {
                window.location.href = routes[previousPage];
            } else {
                window.location.href = routes.choices;
            }
        }

        function openGallery() {
            // Navigate using Flask route
            window.location.href = '/gallery';
        }

        function closeMessage() {
            document.getElementById('messageContainer').style.display = 'none';
        }

        // Load responses and handle mood messages
        let responses = {};

        async function loadResponses() {
            try {
                const response = await fetch('../responses.json');
                responses = await response.json();
            } catch (error) {
                console.error('Error loading responses:', error);
            }
        }

        // Check for mood message on page load
        window.addEventListener('load', async function () {
            await loadResponses();

            const moodMessage = localStorage.getItem('moodMessage');
            const currentMood = localStorage.getItem('currentMood');

            if (moodMessage && currentMood) {
                displayMoodResponse(moodMessage, currentMood);
                // Clear the message after displaying
                localStorage.removeItem('moodMessage');
            }

            // Auto-resume music if previously playing
            loadAndResumeMusic();
        });

        // Persist music state helpers
        function saveMusicState() {
            try {
                if (audio && currentSong) {
                    localStorage.setItem('bgm_song', currentSong);
                    localStorage.setItem('bgm_time', String(audio.currentTime || 0));
                    localStorage.setItem('bgm_playing', String(musicPlaying));
                }
            } catch (e) { /* ignore quota errors */ }
        }

        function loadAndResumeMusic() {
            // If inside app shell, let the shell manage music; do not auto-play locally
            if (IN_SHELL) return;
            const song = localStorage.getItem('bgm_song');
            const playing = localStorage.getItem('bgm_playing') === 'true';
            const time = parseFloat(localStorage.getItem('bgm_time') || '0');
            if (song && playing) {
                audio = new Audio(`/me/music/${song}`);
                audio.loop = true;
                audio.addEventListener('loadedmetadata', () => {
                    if (!isNaN(time)) {
                        try { audio.currentTime = time; } catch (e) {}
                    }
                });
                audio.play().then(() => {
                    musicPlaying = true;
                    currentSong = song;
                    const cardP = document.querySelector('.action-card:nth-child(3) p');
                    if (cardP) cardP.textContent = `Playing: ${getSongDisplayName(song)}`;
                    const stopBtn = document.querySelector('.stop-music');
                    if (stopBtn) stopBtn.style.display = 'block';
                    const musicOptions = document.querySelector('.music-options');
                    if (musicOptions) musicOptions.style.display = 'none';
                    if (audio) audio.ontimeupdate = () => saveMusicState();
                }).catch(() => {
                    // If autoplay blocked, leave state; will start on user gesture
                });
            }
        }

        window.addEventListener('beforeunload', saveMusicState);

        function displayMoodResponse(message, mood) {
            const messageContainer = document.getElementById('messageContainer');
            const messageContent = document.getElementById('messageContent');

            // Get mood-specific responses
            const moodData = responses.moodResponses && responses.moodResponses[mood];

            let acknowledgment = "I received your message baby.";
            let botResponse = "Thank you for sharing that with me love.";

            if (moodData) {
                acknowledgment = moodData.acknowledgment;
                const possibleResponses = moodData.responses;
                botResponse = possibleResponses[Math.floor(Math.random() * possibleResponses.length)];
            }

            // Create message display
            messageContent.innerHTML = `
                <div class="user-message">
                    <div class="message-bubble user-bubble">
                        <p><strong>Your ${mood} message:</strong></p>
                        <p>"${message}"</p>
                        <span class="timestamp">${new Date().toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit',
                        })}</span>
                    </div>
                </div>
                <div class="bot-message">
                    <div class="message-bubble bot-bubble">
                        <p>${acknowledgment}</p>
                        <span class="timestamp">${new Date().toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit',
                        })}</span>
                    </div>
                </div>
                <div class="bot-message">
                    <div class="message-bubble bot-bubble">
                        <p>${botResponse}</p>
                        <span class="timestamp">${new Date().toLocaleTimeString([], {
                            hour: '2-digit', 
                            minute: '2-digit',
                        })}</span>
                    </div>
                </div>
            `;

            // Show the message container
            messageContainer.style.display = 'block';

            // Update speech bubble
            const speechBubble = document.querySelector('.speech-bubble p');
            if (speechBubble) {
                speechBubble.textContent = acknowledgment;

                // Change back after 5 seconds
                setTimeout(() => {
                    speechBubble.textContent = "Hi babe! Welcome to my room üíô";
                }, 5000);
            }
        }
    </script>
</body>
</html>
